<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<link href="/bootstrap-3.4.1-dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="/bootstrap-3.4.1-dist/js/jquery-3.3.1.min.js"></script>
<script src="/bootstrap-3.4.1-dist/js/bootstrap.min.js"></script>
<script src="/bootstrap-3.4.1-dist/js/bootbox.min.js"></script>
<script src="/bootstrap-3.4.1-dist/js/bootbox.locales.min.js"></script>
<link href="/DataTables/css/jquery.dataTables.min.css" rel="stylesheet" />
<script src="/DataTables/js/jquery.dataTables.js"></script>
<link href="/bootstrap-fileinput/css/fileinput.min.css" rel="stylesheet" />
<script src="/bootstrap-fileinput/js/fileinput.min.js"></script>
<script src="/bootstrap-fileinput/js/locales/zh.js"></script>
<link href="/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
<script src="/bootstrap-datetimepicker/js/moment-with-locales.js"></script>
<script src="/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<body>
<style>
    .abc{
        display: none;
    }
</style>
<nav class="navbar navbar-inverse" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">超市管理系统</a>
        </div>
        <div>
            <ul class="nav navbar-nav">
                <li id="dlname"></li>
                <li ><a href="/static/index.html">商品管理</a></li>
                <li ><a href="#">地区管理</a></li>
                <li><a href="#">类型管理</a></li>
                <li class="dropdown"><a href="#" class="dropdown-toggle"
                                        data-toggle="dropdown">系统管理<b class="caret"></b>
                </a>
                    <ul class="dropdown-menu">
                        <li><a href="/role/index.html">角色管理</a></li>
                        <li><a href="#">用户管理</a></li>
                        <li><a href="/permission/index.html">权限管理</a></li>
                        <li><a href="/dept/index.html">部门管理</a></li>
                    </ul></li>
            </ul>
        </div>
    </div>
</nav>
<div class="panel panel-primary">
    <div class="panel-heading">
        条件查询
    </div>
    <div class="panel-body">
        <form class="form-horizontal" id="selectform" method="post">
            <div class="container">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">商品名:</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" name="name" placeholder="请输入商品名">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">价格:</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <input type="text" class="form-control" name="minprice">
                                    <span class="input-group-addon">至</span>
                                    <input type="text" class="form-control" name="maxprice">
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">销量:</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <input type="text" class="form-control" name="minsales">
                                    <span class="input-group-addon">至</span>
                                    <input type="text" class="form-control" name="maxsales">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">条形码:</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" name="barcode">
                            </div>
                        </div>
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">库存:</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                <input type="text" class="form-control" name="minstock">
                                <span class="input-group-addon">至</span>
                                <input type="text" class="form-control" name="maxstock">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">生产日期:</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <input type="text" class="form-control" name="minproducedDate">
                                    <span class="input-group-addon">至</span>
                                    <input type="text" class="form-control" name="maxproducedDate">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label  class="col-sm-3 control-label">保质期(月份):</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <input type="text" class="form-control" name="minshelflife">
                                    <span class="input-group-addon">至</span>
                                    <input type="text" class="form-control" name="maxshelflife">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">状态:</label>
                            <div class="col-sm-9">
                                <input type="radio" name="status" value="0">上架
                                <input type="radio" name="status" value="1">下架
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label  class="col-sm-3 control-label">产地:</label>
                            <div class="col-sm-9" id="areadiv">

                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">

                    </div>
                </div>
                <div class="row">
                    <div style="padding-left:120px">
                        <button type="button" onclick="search()" class="btn btn-primary">
                            <span class="glyphicon glyphicon-search"></span>查询
                        </button>
                        &nbsp;
                        <button type="reset" class="btn btn-danger">
                            <span class="glyphicon glyphicon-refresh"></span>重置
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="panel panel-primary">
    <div class="panel-heading">商品列表</div>
    <div class="panel-body">
        <div style="margin-bottom:10px">

            <button type="button" onclick="addGoods()" class="btn btn-primary">
                <span class="glyphicon glyphicon-plus"></span>新增
            </button>
            <button type="button" onclick="plsc()" class="btn btn-danger">
                <span class="glyphicon glyphicon-minus"></span>批量删除
            </button>
            <button type="button" onclick="xia()" class="btn btn-danger">
                <span class="glyphicon glyphicon-minus"></span>一键下架(过期商品)
            </button>
        </div>
        <table id="aa" class="table table-striped table-bordered">
            <thead>
            <tr>
                <th><input type="checkbox" onclick="qx(this)"></th>
                <th>商品名称</th>
                <th>价格</th>
                <th>销量</th>
                <th>条形码</th>
                <th>库存</th>
                <th>商品图片</th>
                <th>生产日期</th>
                <th>保质期</th>
                <th>状态</th>
                <th>产地</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>
<div style="display: none" id="jinchudiv">
    <input type="text" class="form-control" id="jinchu">
</div>
</body>

<script>
    function qx(a){
        $("[name=pl]").each(function(){
            this.checked=a.checked;
        })
    }



    function plsc(){
        bootbox.confirm({
            title:"<b><font color='red'>删除提示</font></b>",
            message:"您确定要删除吗",
            buttons:{
                confirm:{
                    label:"确定",
                    className:"btn btn-primary"
                },
                cancel:{
                    label:"取消",
                    className:"btn btn-danger"
                }
            },
            callback:function(data){
                if(data){
                    var arr=[];
                    $("[name=pl]:checked").each(function(){
                        arr.push(this.value);
                    })
                    if(arr.length>0){
                        $.ajax({
                            dataType:"json",
                            data:{ids:arr},
                            url:"http://localhost:8888/deleteAllGoods",
                            success:function(data){
                                if(data.code==200){
                                    alert("删除成功");
                                    search();
                                }else{
                                    alert("删除失败");
                                }
                            }

                        })
                    }else{
                        alert("请先选择");
                    }







                }
            }



        })


    }





    function del(id){
        bootbox.confirm({
            title:"<b><font color='red'>删除提示</font></b>",
            message:"您确定要删除吗",
            buttons:{
                confirm:{
                    label:"确定",
                    className:"btn btn-primary"
                },
                cancel:{
                    label:"取消",
                    className:"btn btn-danger"
                }
            },
            callback:function(data){
                if(data){
                    $.ajax({
                        dataType:"json",
                        data:{id:id},
                        url:"http://localhost:8888/deleteGoods",
                        success:function(data){
                            if(data.code==200){
                                alert("删除成功");
                                search();
                            }else{
                                alert("删除失败");
                            }
                        }

                    })






                }
            }



        })



    }


</script>


<script>







    function hx(id){

        $.ajax({
            data: {"movieid": id},
            dataType: "json",
            url: "http://localhost:8888/inittoken2",
            success: function (data) {
                if (data.code == 200) {
                  location.href="update.html?id="+data.data;
                }

            }
        })

    }


   function addGoods(){
        location.href="add.html";
   }




</script>







<script>





    var selecttable;
    var o={value:1};
    $(function(){
        pageselect();
        erji(o);
        initdate("minproducedDate");
        initdate("maxproducedDate");
    })


    function search(){
        selecttable.ajax.reload();
    }

    function initdate(a,b){
        $("[name="+a+"]").datetimepicker({
            format:b==undefined?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD",
            locale:"zh-CN",
            showClear:true
        })
    }


    function pageselect(){
        selecttable=$("#aa").DataTable({
            serverSide:true,
            processing:true,
            language:{
                "sProcessing": "处理中...",
                "sLengthMenu": "显示 _MENU_ 项结果",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            },
            searching:false,
            ordering:false,
            ajax:{
                url:"http://localhost:8888/selectGoods",
                type:"post",
                contentType:"application/json",
                data:function(d){
                   d.name=$("[name=name]").val();
                   d.minprice=$("[name=minprice]").val();
                   d.maxprice=$("[name=maxprice]").val();
                   d.minsales=$("[name=minsales]").val();
                    d.maxsales=$("[name=maxsales]").val();
                   d.barcode=$("[name=barcode]").val();
                   d.minstock=$("[name=minstock]").val();
                   d.maxstock=$("[name=maxstock]").val();
                   d.minproducedDate=$("[name=minproducedDate]").val();
                   d.maxproducedDate=$("[name=maxproducedDate]").val();
                    d.minshelflife=$("[name=minshelflife]").val();
                    d.maxshelflife=$("[name=maxshelflife]").val();
                   d.status=$("[name=status]:checked").val();
                   d.areaid=$("#areadiv select").eq(1).val();
                   return JSON.stringify(d);
                },
                dataSrc: function (json) {
                    json.draw = json.data.draw;
                    json.recordsTotal = json.data.recordsTotal;
                    json.recordsFiltered = json.data.recordsFiltered;
                    //json.data=json.data.data;
                    return json.data.data;
                }
            },
            columns:[
                {data:"id","render":function (data) {
                        return "<input type=checkbox name=\"pl\" value=\""+data+"\">";
                    }},
                {data:"name", width:"5%"},
                {data:"price"},
                {data:"sales"},
                {data:"barcode"},
                {data:"stock"},
                {data:"filename",render:function(data){
                        return "<img width='30px' height='50px' src=\""+data+"\">";
                    }},
                {data:"producedDate"},
                {data:"shelflife",width:"3%",render:function(data){
                    return data+"个月";
                    }},
                {data:"status",width:"3%",render:function(data){
                    return data==1?"下架":"上架"
                    }},
                {data:"areaname"},
                {data:"id",
                width:"14%"
                ,
                    "render":function(data,type,row){
                        return '<div class="btn-group btn-group-xs">'+
                            '<button type="button" name="buybtn" onclick="hx('+data+')" class="btn btn-danger">'+
                            '<span class="glyphicon glyphicon-shopping-cart"></span>&nbsp;修改'+
                            '</button>'+
                            '<button type="button" name="buybtn" onclick="del('+data+')" class="btn btn-danger">'+
                            '<span class="glyphicon glyphicon-shopping-cart"></span>&nbsp;删除'+
                            '</button>'+
                            '<button type="button" name="buybtn" onclick="jin('+data+')" class="btn btn-danger">'+
                            '<span class="glyphicon glyphicon-shopping-cart"></span>&nbsp;进货'+
                            '</button>'+
                            '<button type="button" name="buybtn" onclick="chu('+data+','+row.stock+')" class="btn btn-danger">'+
                            '<span class="glyphicon glyphicon-shopping-cart"></span>&nbsp;出货'+
                            '</button>'+
                            '<button type="button" style='+(row.status==0?'"display:none"':'')+' name="buybtn" onclick="shang('+data+')" class="btn btn-danger">'+
                            '<span class="glyphicon glyphicon-shopping-cart"></span>&nbsp;上架'+
                            '</button>'+
                            '<button type="button" style='+(row.status==1?'"display:none"':'')+' name="buybtn" onclick="shang('+data+')" class="btn btn-danger">'+
                            '<span class="glyphicon glyphicon-shopping-cart"></span>&nbsp;下架'+
                            '</button>'+
                            '</div>';
                    }}
            ]



        })

    }





</script>


<script>
    function erji(obj){
        var lavel;
        if(obj){
            $(obj).nextAll().remove();
            lavel=$(obj).prevAll().length;
        }
        if(lavel!=undefined&&lavel>0){
            return;
        }
        $.ajax({
            data: {"pid": obj.value},
            dataType: "json",
            url: "http://localhost:8888/selectAreaByPid",
            success: function (data) {
                if (data.code == 200) {
                   var arealist=data.data;
                   var selecthtml="<select class='form-control' onchange='erji(this)'><option value=''>-请选择-</option>";
                    for (var i = 0; i < arealist.length; i++) {
                        selecthtml+="<option value='"+arealist[i].id+"'>"+arealist[i].name+"</option>";
                    }
                    selecthtml+="</select>";
                    $("#areadiv").append(selecthtml);
                }

            }
        })

    }

    function shang(id){
        $.ajax({
            data: {"id":id},
            dataType: "json",
            url: "http://localhost:8888/updateStatus",
            success: function (data) {
                if (data.code == 200) {
                    search();
                }

            }
        })
    }



    function xia(){
        $.ajax({
            dataType: "json",
            url: "http://localhost:8888/updateAllStatus",
            success: function (data) {
                if (data.code == 200) {
                    search();
                }

            }
        })
    }

    function jin(id){
        jinchuhtml=$("#jinchudiv").html();
        var abc;
        $.ajax({
            dataType: "json",
            url: "http://localhost:8888/inittoken1",
            success: function (data) {
                if (data.code == 200) {
                    abc=data.data;
                }

            }
        })
        bootbox.confirm({
            title:"进货",
            message:$("#jinchudiv").children(),
            buttons:{
                confirm:{
                    label:"确定",
                    className:"btn btn-primary"
                },
                cancel:{
                    label:"取消",
                    className:"btn btn-danger"
                }
            },
            callback:function(data){
                if(data){
                    var count=$("#jinchu").val();
                    var zhengze=/\d/;
                    if(!zhengze.test(count)){
                        alert("输入错误");
                        $("#jinchudiv").html(jinchuhtml);
                        return;
                    }
                    $.ajax({
                        data:{"id":id,"stock":0-count,"abc":abc},
                        dataType: "json",
                        url: "http://localhost:8888/updateStock",
                        success: function (data) {
                            if (data.code == 200) {
                                if(data.data==null){
                                    search();
                                }else{
                                    var str=data.data.name+"库存不足";
                                    alert(str);
                                }
                            }

                        }
                    })



                }
                $("#jinchudiv").html(jinchuhtml);
            }
        })



    }

var jinchuhtml;
    function chu(id,stock){
        jinchuhtml=$("#jinchudiv").html();
        var abc;
        $.ajax({
            dataType: "json",
            url: "http://localhost:8888/inittoken1",
            success: function (data) {
                if (data.code == 200) {
                    abc=data.data;
                }

            }
        })
        bootbox.confirm({
            title:"出货",
            message:$("#jinchudiv").children(),
            buttons:{
                confirm:{
                    label:"确定",
                    className:"btn btn-primary"
                },
                cancel:{
                    label:"取消",
                    className:"btn btn-danger"
                }
            },
            callback:function(data){
                if(data){
                    var count=$("#jinchu").val();
                    var zhengze=/\d/;
                    if(!zhengze.test(count)){
                        alert("输入错误");
                        $("#jinchudiv").html(jinchuhtml);
                        return;
                    }
                    if(count>stock){
                        alert("库存不足");
                        $("#jinchudiv").html(jinchuhtml);
                        return;
                    }
                    $.ajax({
                        data:{"id":id,"stock":count,"abc":abc},
                        dataType: "json",
                        url: "http://localhost:8888/updateStock",
                        success: function (data) {
                            if (data.code == 200) {
                                if(data.data==null){
                                    search();
                                }else{
                                    var str=data.data.name+"库存不足";
                                    alert(str);
                                }
                            }

                        }
                    })



                }
                $("#jinchudiv").html(jinchuhtml);
            }
        })



    }



</script>


</html>